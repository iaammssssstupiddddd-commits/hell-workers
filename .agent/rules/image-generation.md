---
trigger: always_on
---

# 画像生成・透過 PNG 作成ルール

このプロジェクトで UI アイコンやスプライトを生成する際は、以下の標準フローを厳守すること。AI 生成ツールの不安定さ（JPEG 偽装や背景の格子模様）を回避し、Bevy で確実に動作する透過 PNG を作成するための手順である。

## 1. 画像生成（generate_image）
- **プロンプトの指定**: 
    - 必ず「背景を純粋なマゼンタ（solid pure magenta background, #FF00FF）」にするよう指定する。
    - 透過（transparent background）は指定**しない**。AI が透過の代わりに格子模様（チェッカーボード）を描き込み、修復不能になるのを防ぐためである。
- **スタイル**: 必要に応じて「ピクセルアート（pixel art style）」や「32x32」などのサイズを指定する。

## 2. 透過 PNG への変換
- **変換スクリプトの実行**: 
    生成された画像（たとえ拡張子が .png であっても中身が JPEG の場合がある）を、プロジェクトの Python スクリプトで変換する。
- **コマンド例**:
    ```powershell
    python scripts/convert_to_png.py "生成された画像パス" "assets/textures/対象パス.png"
    ```
- **処理の仕組み**: 
    スクリプトはマゼンタ（#FF00FF）を検知し、アルファ値を 0 に変換する。JPEG 圧縮によるノイズ（わずかな色のズレ）も閾値判定で適切に処理される。

## 3. アセットの検証
- **バイナリチェック**: 
    Bevy の `AssetServer` は拡張子でデコーダを決定するため、中身が正しく PNG 署名であることを確認する。
    - PowerShell での確認コマンド:
      ```powershell
      powershell -Command "[BitConverter]::ToString((Get-Content '変換後のファイルパス' -Encoding Byte -TotalCount 8))"
      ```
    - 正しい出力: `89-50-4E-47-0D-0A-1A-0A`

## 4. コードへの適用
- `src/plugins/startup.rs` などでロードする際は、必ず `.png` 拡張子を使用する。

---

> [!IMPORTANT]
> **なぜこのルールが必要か？**
> AI 生成ツールは、透過を要求すると「透過に見える格子模様」を描いてしまうことが多く、また背景が白や黒だとアンチエイリアス部分に色が残りやすい。
> マゼンタ（#FF00FF）はゲーム内アセットで使われることがほぼない色（クロマキー）であり、高精度な「抜き」が可能になる。
