# タスクシステム (Task System)

このドキュメントでは、Hell-Workers におけるタスク（仕事）の指定、割り当て、管理、および実行の仕組みについて解説します。

## 1. 概要
タスクシステムは、プレイヤーまたはシステム（使い魔 AI）が世界中の実体（木、岩、アイテムなど）に対して「仕事（WorkType）」を指定し、それを適切な「魂（Damned Soul）」が実行するまでを管理します。

## 2. 主要なコンポーネント

Bevy 0.18 の **ECS Relationships** 機能を使用し、エンティティ間の参照を双方向かつ型安全に管理しています。

| コンポーネント | 役割 | 説明 |
| :--- | :--- | :--- |
| `Designation` | 基本 | エンティティが仕事の対象であることを示すフラグ。`WorkType` を持つ。 |
| `TaskSlots` | 制限 | 1つのタスクに同時に取り組める最大人数を管理する（参加人数は `TaskWorkers` で自動集計される）。 |
| **`ManagedBy(Entity)`** | **Relationship** | タスクから**使い魔**への参照。エイリアス: `IssuedBy`。 |
| **`ManagedTasks(Vec)`** | **Target** | 使い魔側の**管理タスク一覧**。自動的に維持される。 |
| **`WorkingOn(Entity)`** | **Relationship** | 魂から**タスク**への参照。 |
| **`TaskWorkers(Vec)`** | **Target** | タスク側の**作業者一覧**。自動的に維持される。 |
| **`Holding(Entity)`** | **Relationship** | 魂から**保持アイテム**への参照。 |
| **`HeldBy(Vec)`** | **Target** | アイテム側の**保持者一覧**（通常は1人）。自動的に維持される。 |
| **`StoredIn(Entity)`** | **Relationship** | アイテムから**備蓄場所**への参照。 |
| **`StoredItems(Vec)`** | **Target** | 備蓄場所側の**格納アイテム一覧**。自動的に維持される。 |

### Relationship のメリット
- **自動クリーンアップ**: 使い魔やタスクのエンティティが削除された際、関連する Relationship コンポーネントも Bevy によって自動的にクリーンアップされます。
- **効率的な逆引き**: 特定の使い魔が持つタスク一覧や、特定のタスクに取り組んでいる作業者一覧を、全エンティティをスキャンすることなく O(1) または O(人数) で取得できます。

## 3. タスクキュー (Task Queue)

タスクは以下のいずれかのキューで管理されます：

- **`TaskQueue`**: 使い魔（IssuedBy）ごとに管理されるキュー。使い魔の配下の魂が優先的に処理する。
- **`GlobalTaskQueue`**: `IssuedBy` がない「未指定」のタスクが入るキュー。

## 4. タスクのライフサイクル

### 1. 指定 (Designation)
- **手動**: プレイヤーが UI やドラッグ操作で指定。
- **自動**: `soul_ai::work::task_area_auto_haul_system` が備蓄場所周辺の資源を自動的に `Haul` 指定。

### 2. 割り当て (Assignment)
- 使い魔 AI が自分のキュー、またはグローバルキューから最も近い有効なタスクを配下の魂に割り当てる。
- **優先度 (Priority)**:
    - **High (10)**: 建築作業 (`WorkType::Build`)、建築資材の運搬（設計図への `Haul`）。これらは距離に関わらず最優先で割り当てられる。
    - **Low (0)**: 通常の資源採取、備蓄への運搬。
    - 同じ優先度内では、使い魔からの距離が近いものが選ばれる。
- 魂の `AssignedTask` コンポーネントにターゲット情報が書き込まれる。
- **リクルート条件**: 使い魔は `command_radius`（影響範囲）内のワーカーのみリクルート可能。範囲外でも空きがあればスカウトに向かう（詳細は [familiar_ai.md](familiar_ai.md) 参照）。
- **疲労チェック**: 各使い魔が設定した `fatigue_threshold` を超えるワーカーにはタスクを割り当てない。
- **監視モードへの遷移**: 部下が上限（`max_controlled_soul`）に達した時点で自動的に `Supervising` 状態へ移行する。

### 3. 実行 (Execution)
- 魂が移動し、ターゲットに対して作業を行う。
- **採取 (Gather)**: 作業完了時に資源がドロップされます。
    - **木 (Tree)**: `Wood` x 5 をドロップ。
    - **岩 (Rock)**: `Rock` x 10 をドロップ。**作業時間は木の約2倍**かかる重労働です。
    - **スタック**: 報酬は同一タイル内にドロップされ、アイテム個数としてまとめてカウント（スタック）されます。
- **運搬 (Haul)**: 「拾う」「備蓄場所へ運ぶ」「置く」のフェーズを経る。

### 4. 完了・放棄 (Completion / Abandonment)
- **完了**: 資源が消滅、または目的地に到達。`AssignedTask::None` に戻り、コンポーネントがクリーンアップされる。この際、`OnTaskCompleted` イベントが発行される。
- **放棄（ストレス）**: ストレス崩壊（`OnStressBreakdown`）時に即座に中断。
- **放棄（モチベーション）**: **やる気が 0.3 (30%) を下回った際**、自発的にタスクを放棄 (`OnTaskAbandoned`)。
- **放棄（疲労）**: 疲労限界（`OnExhausted`）時に即座に中断し、集会所へ移動。
- **解雇**: 使い魔からの指揮解除によって中断。
- **割り当て通知**: タスクが割り当てられた際には `OnTaskAssigned` イベントが発行される。

これらのイベントは Bevy 0.18 の **Observer** によって処理され、ログ出力や関連エンティティの状態更新が即座に行われます。

## 5. 重要なメンテナンスロジック

### `unassign_task`
タスクが中断された際、以下の処理を確実に行います：
- **グリッド中心への吸着 (Grid Snapping)**: アイテムをドロップする際、タイルの中央（真の中心）に座標を補正する。
- **予約の完全解除**: `Designation` を一旦削除し、資源を「真っ白」な未指定状態に戻す。これにより、AI が次フレームで再度フレッシュなタスクとして検知・再割り当てできる。

### 座標系 (Coordinate System)
- マップ全体は **(MAP_WIDTH - 1) / 2.0 (50x50 なら 24.5)** を数学的中心として定義されている。
- タイルの中心とワールド座標の整数値が一致するように設計されており、これにより 1px の狂いもない表示と判定を実現している。

## 6. オートホール (Auto-Haul)
使い魔の `TaskArea`（担当エリア）内に **`Stockpile`（備蓄場所）** がある場合、その周辺の未指定資源を自動的に `Haul` タスクとして登録するシステム。
詳細は [logistics.md](logistics.md) を参照してください。
- 効率化のため空間グリッド（`ResourceSpatialGrid` および **`DesignationSpatialGrid`**）を利用して検索を行う。
- 型の一致（木材/石材）と備蓄場所の容量（最大10個）を厳格にチェックします。
- 同一フレーム内での過剰なタスク発行を抑えるため、予約済みの資源はスキップする。
- 数千の指示が存在する状況でも、使い魔はエリア内の未アサインタスクを O(1) に近い速度で発見できます。

## 7. 疲労とストレス (Vitals)

ワーカーの疲労、ストレス、やる気、およびそれらに基づく待機行動（休息、ブレイクダウン等）の詳細については、[soul_ai.md](soul_ai.md) を参照してください。
