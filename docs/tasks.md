# タスクシステム (Task System)

このドキュメントでは、Hell-Workers におけるタスク（仕事）の指定、割り当て、管理、および実行の仕組みについて解説します。

## 1. 概要
タスクシステムは、プレイヤーまたはシステム（使い魔 AI）が世界中の実体（木、岩、アイテムなど）に対して「仕事（WorkType）」を指定し、それを適切な「魂（Damned Soul）」が実行するまでを管理します。

## 2. 主要なコンポーネント

| コンポーネント | 説明 |
| :--- | :--- |
| `Designation` | エンティティが仕事の対象であることを示すフラグ。`WorkType`（Chop, Mine, Haul）を持つ。 |
| `IssuedBy(Entity)` | そのタスクを発行した使い魔の Entity。これがある場合、その使い魔の専属タスクとなる。 |
| `ClaimedBy(Entity)` | そのタスクを現在実行中の魂の Entity。これがある間、他の魂はそのタスクを無視する。 |
| `TaskSlots` | 1つのタスクに同時に取り組める最大人数と現在の人数を管理する。 |

## 3. タスクキュー (Task Queue)

タスクは以下のいずれかのキューで管理されます：

- **`TaskQueue`**: 使い魔（IssuedBy）ごとに管理されるキュー。使い魔の配下の魂が優先的に処理する。
- **`GlobalTaskQueue`**: `IssuedBy` がない「未指定」のタスクが入るキュー。

## 4. タスクのライフサイクル

### 1. 指定 (Designation)
- **手動**: プレイヤーが UI やドラッグ操作で指定。
- **自動**: `task_area_auto_haul_system` が備蓄場所周辺の資源を自動的に `Haul` 指定。

### 2. 割り当て (Assignment)
- 使い魔 AI が自分のキュー、またはグローバルキューから最も近い有効なタスクを配下の魂に割り当てる。
- 魂の `AssignedTask` コンポーネントにターゲット情報が書き込まれる。
- **リクルート条件**: 使い魔は `command_radius`（影響範囲）内のワーカーのみリクルート可能。
- **疲労チェック**: 各使い魔が設定した `fatigue_threshold` を超えるワーカーにはタスクを割り当てない。

### 3. 実行 (Execution)
- 魂が移動し、ターゲットに対して作業を行う。
- `Haul`（運搬）の場合は、「拾う」「備蓄場所へ運ぶ」「置く」のフェーズを経る。

### 4. 完了・放棄 (Completion / Abandonment)
- **完了**: 資源が消滅、または目的地に到達。`AssignedTask::None` に戻り、コンポーネントがクリーンアップされる。この際、`OnTaskCompleted` イベントが発行される。
- **放棄（ストレス）**: ストレス崩壊（`OnStressBreakdown`）時に即座に中断。
- **放棄（疲労）**: 疲労限界（`OnExhausted`）時に即座に中断し、集会所へ移動。
- **解雇**: 使い魔からの指揮解除によって中断。
- **割り当て通知**: タスクが割り当てられた際には `OnTaskAssigned` イベントが発行される。

これらのイベントは Bevy 0.17 の **Observer** によって処理され、ログ出力や関連エンティティの状態更新が即座に行われます。

## 5. 重要なメンテナンスロジック

### `unassign_task`
タスクが中断された際、以下の処理を確実に行います：
- **グリッド中心への吸着 (Grid Snapping)**: アイテムをドロップする際、タイルの中央（真の中心）に座標を補正する。
- **予約の完全解除**: `Designation` を一旦削除し、資源を「真っ白」な未指定状態に戻す。これにより、AI が次フレームで再度フレッシュなタスクとして検知・再割り当てできる。

### 座標系 (Coordinate System)
- マップ全体は **(MAP_WIDTH - 1) / 2.0 (50x50 なら 24.5)** を数学的中心として定義されている。
- タイルの中心とワールド座標の整数値が一致するように設計されており、これにより 1px の狂いもない表示と判定を実現している。

## 6. オートホール (Auto-Haul)
使い魔の `TaskArea`（担当エリア）内に **`Stockpile`（備蓄場所）** がある場合、その周辺の未指定資源を自動的に `Haul` タスクとして登録するシステム。
- 効率化のため空間グリッド（`ResourceSpatialGrid`）を利用して検索を行う。
- 同一フレーム内での過剰なタスク発行を抑えるため、予約済みの資源はスキップする。

## 7. 疲労とタスク受付

使い魔ごとに `fatigue_threshold` を設定可能（デフォルト: 80%）。

| 疲労値 | タスク受付 |
|--------|-----------|
| < 使い魔の閾値 | 可能 |
| ≥ 使い魔の閾値 | 不可（使役から解除） |
| > 90% (グローバル) | `ExhaustedGathering` 状態へ移行 |

疲労が90%を超えたワーカーは：
1. 現在のタスクを放棄
2. 使役から解除
3. 集会所へ移動して休息
4. 集会所到着後、`Gathering` 状態に遷移しリクルート対象に戻る
