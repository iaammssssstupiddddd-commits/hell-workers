# Bevy アップデート分析レポート

## 現在の状態

- **現在のバージョン**: Bevy 0.15
- **最新バージョン**: Bevy 0.17 (2025年9月30日リリース)
- **コンパイル状態**: ✅ 正常（エラーなし）

## アップデート候補

### オプション1: Bevy 0.17 に直接アップデート（推奨）
- 最新機能にアクセス可能
- 2つのメジャーバージョンを飛び越えるため、移行作業が必要
- 0.16と0.17の両方の破壊的変更に対応が必要

### オプション2: Bevy 0.16 に段階的にアップデート
- より安全な移行パス
- 一度に一つのバージョンの変更に対応
- その後0.17にアップデート

## 主な破壊的変更（0.15 → 0.17）

### 1. ✅ 影響なし: `Query::many()` / `Query::many_mut()` の非推奨
- **状況**: コードベース内で使用されていない
- **対応**: 不要

### 2. ✅ 影響なし: `insert_or_spawn()` 関数の非推奨
- **状況**: コードベース内で使用されていない
- **対応**: 不要

### 3. ⚠️ 要確認: システムパラメータのバリデーション変更
- **変更**: `ValidationOutcome` enum の導入
- **影響**: カスタムシステムやカスタム `SystemParam` の実装がある場合
- **対応**: カスタムシステム実装を確認し、必要に応じて更新

### 4. ⚠️ 要確認: `Entities` API の変更
- **変更**: `flush()` メソッドのシグネチャ変更、`EntityLocation` → `EntityIdLocation`
- **影響**: `Entities` を直接操作している場合
- **対応**: コードベースを確認中（現在は直接使用していない可能性が高い）

### 5. ⚠️ 要確認: `DynamicBundle` トレイトの変更
- **変更**: `MovingPtr` の使用、`apply_effect` メソッドの追加
- **影響**: カスタムBundle実装がある場合
- **対応**: カスタムBundleの実装を確認

### 6. ✅ 新機能: Reflect Auto-Registration
- **変更**: 手動登録が不要に
- **影響**: `App::register_type` の呼び出しが不要になる可能性
- **対応**: コードクリーンアップの機会

## Bevy 0.17 の主な新機能

1. **Bevy Solari - レイトレーシングライティング**（実験的）
   - 物理的に正確なリアルタイムライティング

2. **観測者とイベントAPIの改善**
   - より柔軟なObserver/Event API

3. **Rust Hotpatching**
   - コードのホットリロード（Bevy ECSシステムに限定）

4. **DLSS サポート**
   - NVIDIA RTX GPU でのアップスケーリングとアンチエイリアシング

5. **UI Gradients**
   - Bevy UIでのグラデーション背景とボーダー

6. **Web Assets**
   - HTTP/HTTPS URLからのアセット読み込み

7. **Frame Time Graphs**
   - フレームタイムデバッグ用の組み込みウィジェット

8. **Tilemap Chunk Rendering**
   - パフォーマントなタイルマップレンダリング

## 推奨されるアップデート手順

### ステップ1: バックアップとブランチ作成
```bash
git checkout -b upgrade/bevy-0.17
```

### ステップ2: Cargo.toml の更新
```toml
bevy = { version = "0.17", features = [...] }
```

### ステップ3: コンパイルエラーの確認
```bash
cargo check
```

### ステップ4: エラーの修正
- 破壊的変更に基づいてエラーを修正
- 警告も可能な限り修正

### ステップ5: テスト
- すべての機能が正常に動作することを確認
- パフォーマンスへの影響を確認

### ステップ6: 新機能の検討（オプション）
- UI Gradients の活用
- Frame Time Graphs の追加
- Web Assets の活用

## リスク評価

### 低リスク
- ✅ 非推奨APIの使用がない
- ✅ 標準的なBevyパターンを使用している
- ✅ コードベースが比較的クリーン

### 中リスク
- ⚠️ 大規模なコードベース（732行のfamiliar_ai.rsなど）
- ⚠️ 複雑なシステム間の依存関係
- ⚠️ 直接的なテストがない（推測）

### 高リスク
- ❌ なし（現時点では）

## 推奨事項

### 即座にアップデートすべきか？
**推奨度: 中**

**理由:**
- 現在のBevy 0.15は安定して動作している
- 0.17の新機能がプロジェクトに必須ではない
- しかし、セキュリティアップデートやバグ修正を含む可能性がある

### 推奨されるタイミング
1. **開発の合間**: 新機能追加の前にアップデート
2. **メンテナンス期間**: 既存機能のバグ修正と同時に
3. **新機能が必要な時**: DLSSやUI Gradientsなどが必要になった時

## 次のステップ

1. ✅ **完了**: コードベースの分析
2. ⏳ **検討中**: アップデートの実行時期の決定
3. ⏳ **保留**: 実際のアップデート作業

## 参考資料

- [Bevy 0.16 Migration Guide](https://bevy.org/learn/migration-guides/0-15-to-0-16)
- [Bevy 0.17 Migration Guide](https://bevy.org/learn/migration-guides/0-16-to-0-17)
- [Bevy 0.17 Release Notes](https://bevy.org/news/bevy-0-17/)
