# ストレスシステム

魂（Soul）はタスク実行中にストレスが蓄積し、限界に達するとブレイクダウンを起こします。

## ストレス値

- **範囲**: 0.0 ～ 1.0（0% ～ 100%）
- **初期値**: 0.0

## 増減ロジック

### 増加

| 状況 | 変化率 | 100%到達時間 |
|------|--------|-------------|
| タスク + 監視下 | +0.0525 × influence × dt | 約20秒 |
| タスク + 監視外 | +0.015 × dt | 約67秒 |

### 減少

| 状況 | 変化率 | 0%到達時間 |
|------|--------|-----------| 
| 待機（影響範囲内） | ±0 | 変化なし |
| 待機（影響範囲外） | -0.02 × dt | 約50秒 |
| 集会中 | -0.04 × dt | 約25秒 |

## ブレイクダウン

ストレスが100%に達すると `OnStressBreakdown` イベントが発行され、Observerによって以下の処理が即座に実行されます：

| ストレス値 | 状態 | 動作 |
|-----------|------|------|
| ≥ 100% | 発動 | 停止 + タスク放棄 (`WorkingOn`の解除) + 使役解除 (`CommandedBy`の解除) |
| ≤ 90% | 回復中 | 動けるようになる（使役はまだ拒否） |
| ≤ 70% | 完全回復 | ブレイクダウン解除、通常状態に戻る |

## 疲労との連携

疲労システムとの主な違い：

| 項目 | ストレス | 疲労 |
|------|---------|------|
| 閾値 | 固定（100%） | 使い魔ごとに設定可能 |
| 回復場所 | どこでも（待機中に回復） | 集会所で最速回復 |
| 強制移動 | なし | 集会所へ強制移動 |

## タスク関連イベント

| イベント | トリガー条件 | 処理内容 |
|---------|-------------|---------|
| `OnTaskAssigned` | タスク割り当て時 | ログ出力 |
| `OnTaskCompleted` | タスク完了時 | ログ出力 |
| `OnStressBreakdown` | ストレス100%到達 | タスク放棄 + 使役解除 |
| `OnExhausted` | 疲労90%超過 | タスク放棄 + 使役解除 + 集会所移動 |

これらのイベントは Bevy 0.17 の **Observer** によって処理され、即座にログ出力や状態更新が行われます。

## 関連ファイル

- `src/events.rs` - `OnStressBreakdown`, `OnExhausted` イベント定義
- `src/entities/damned_soul.rs` - Observer ハンドラの実装と登録
- `src/systems/stress.rs` - ストレス更新およびイベントのトリガー
- `src/systems/fatigue.rs` - 疲労更新およびイベントのトリガー
- `src/systems/idle.rs` - 集会所での振る舞い
