# 動的集会システム (Dynamic Gathering System)

Soulの待機行動に基づいて自然発生的に集会所が生成され、人が集まるにつれて拡大し、距離に応じて統合され、過疎化すると消滅する動的なシステム。

## 概要

| 項目 | 値 |
|:---|:---|
| 最大参加人数 | 8人 |
| 維持最低人数 | 2人 |
| 発生待機時間 | 10秒 (近傍Soul数で短縮) |
| 消滅猶予時間 | 10秒 |

## 中心オブジェクト確率

オブジェクトは発生時にランダム決定。人数によって確率が変動:

| 人数 | Nothing | CardTable | Campfire | Barrel |
|:---:|:---:|:---:|:---:|:---:|
| 1〜4人 | **50%** | 30% | 10% | 10% |
| 5〜6人 | 20% | **50%** | 20% | 10% |
| 7〜8人 | 5% | 25% | **40%** | **30%** |

> [!NOTE]
> 参加人数が **2人未満 (1人以下)** の場合、中心オブジェクト（カードテーブル、焚き火、樽）は非表示になります。
> 紫色のオーラのみが表示され、2人目が参加した時点でオブジェクトが出現します。

## 統合 (マージ) ルール

集会スポット同士が一定距離内に近づくと統合されます。統合距離は時間経過とともに拡大します。

- **初期統合距離**: 2.0タイル
- **最大統合距離**: 10.0タイル
- **拡大速度**: `0.3タイル/秒 × (最大人数 / 現在人数)`
  - 人数が少ない集会ほど急速に統合範囲が広がり、近くの集会に吸収されやすくなります。
- **吸収ルール**:
  - 人数が多い方が残る
  - 人数が同じ場合は先に生成された方が残る
  - **合計人数が最大容量 (8人) を超える場合は統合されない**

## 参加・離脱ルール

- **自動参加**: スポット中心から 5.0タイル 以内にいる Soul が自動的に参加者リストに登録。
- **自動離脱**:
  - スポット中心から 7.5タイル 以上離れた Soul は自動的に離脱。
  - 集会行動（Gathering/ExhaustedGathering）中の Soul はどれだけ離れても明示的な行動終了まで離脱しない。
- **回避**: 参加中の Soul はスポットの中心点から一定距離（ソーシャルディスタンス）を保つように移動ベクトルを修正する。

## デバッグ機能

- **接続線の表示**: 集会の中心（1タイル以内）または参加 Soul にマウスをホバーすると、中心点と全参加者を結ぶ紫色の線が表示される。
- **ログ**: スポットの発生、統合、参加、離脱時に詳細な INFO ログを出力。

## 関連ファイル

- [gathering.rs](file:///home/iaamm/projects/hell-workers/src/systems/soul_ai/gathering.rs)
- [提案書](proposals/dynamic_gathering.md)
