# 使い魔 AI (Familiar AI)

使い魔（Familiar）は、「地獄の監督官」として配下の魂（Damned Soul）を管理し、仕事を効率的に進めさせるための AI を備えています。

## 1. AI 状態 (FamiliarAiState)

使い魔は以下の 4 つの状態を持ち、状況に応じて遷移します。

| 状態 (State) | 説明 |
| :--- | :--- |
| **`Idle`** | プレイヤーからの命令が `Idle` の状態。その場に留まります。 |
| **`SearchingTask`** | 次の仕事（Designation）を探している状態。担当エリアを巡回します。 |
| **`Scouting`** | 遠方のフリーの魂をリクルートするために接近している状態。 |
| **`Supervising`** | 配下の魂を監視し、仕事の進捗を管理している状態。 |

## 2. 使役とリクルート (Recruitment)

使い魔は最大 `max_controlled_soul`（個体差あり）名までの部下を持つことができます。

### 使役数の上限変更

使い魔の使役数上限（`max_controlled_soul`）は、オペレーションダイアログから変更可能です（範囲: 1〜8）。

- **イベント駆動**: 使役数の変更は `FamiliarOperationMaxSoulChangedEvent` イベントで通知されます。
- **自動リリース**: 使役数を減少させた場合、超過分の魂が自動的にリリースされます。
  - タスクが割り当てられている場合は、タスクを解除してからリリースされます。
  - リリース時には使い魔がフレーズを表示します。
- **パフォーマンス**: 毎フレームチェックではなく、変更時のみ処理が実行されるため、パフォーマンスに優れています。

### リクルート条件

魂がリクルート対象となるための条件（詳細は [soul_ai.md](soul_ai.md) 参照）：

1. **未使役**: `CommandedBy` コンポーネントがないこと
2. **タスクなし**: `AssignedTask::None` であること
3. **バイタル良好**: 疲労・ストレスが閾値以下であること
4. **休息中でない**: `ExhaustedGathering` 状態でないこと

> **Note**: リクルート閾値はリリース閾値より低下させて設定されており、リクルート直後にリリースされることを防ぎます。

### リクルート挙動

- **即時リクルート**: `command_radius` 内に条件を満たす魂がいる場合、即座に配下に入れます。
- **スカウト挙動**: 範囲内に魂がいない場合、段階的に検索範囲を拡大（20→40→80→160タイル）して最適な魂を探し、その場所まで移動してリクルートします。
- **リクルート遷移**: リクルート成功後、まだ空きがあれば再び `SearchingTask` に戻って仲間を探します。満員になった場合のみ `Supervising` に移行します。

## 3. 監視ロジック (Supervising)

監視モードでは、部下との「適切な距離」を保ちながら行動します。

### ターゲット選定
- **作業者優先**: 部下の中で「現在タスクを実行中（`AssignedTask` が `None` 以外）」の者を優先的にターゲットにします。
- **固定タイマー (Sticky Target)**: 頻繁なターゲット切り替えによるカクつきを防ぐため、一度ターゲットを決めたら **2.0 秒間** はその魂を注視し続けます。

### 誘導 (Guidance)
- **エリアへの回帰**: 全員が待機（Idle）状態で、かつ担当エリアの中心から **1.5 タイル** 以上離れている場合、使い魔はエリアの中心へ移動を開始します。部下はこれに合わせてエリア内へ誘導されます。

- **停止**: ターゲットとの距離が **3.0 タイル** 以内になったら停止。

### 3.4. 激励 (Encouragement) System
監視モード中、使い魔はランダムなタイミングで配下の魂を「激励」することがあります。
- **発動条件**: `Supervising` 状態かつ `Idle` 命令以外。
- **効果**: 対象一人に対し、**やる気 +2.5%** のボーナスを与える。
- **コスト**: 対象の **ストレス +1.25%** 増加。
- **演出**: 使い魔から「🔥」「⚡」等の激励絵文字、魂から「💪」または「😓」のリアクションが表示されます。
- **制限**: 同一の魂に対し **30秒間** のクールダウンがあります。

## 4. 移動と経路探索の最適化

使い魔の動きをスムーズにするため、以下の制御が行われています。

- **パス更新ガード**: 目的地が **0.5 〜 1.0 タイル** 以上変化しない限り、新しい経路（Path）を再計算しません。これにより、微小な移動に伴う「ガタつき」を排除しています。
- **明示的なパス解放**: 停止距離に到達した際、即座に経路情報をクリアすることで、ターゲット周囲での「足踏み」を防いでいます。

## 5. システム構造

`familiar_ai` システムは、保守性と可読性を向上させるため、以下のモジュールに分離されています：

### 5.1. 主要モジュール

- **`mod.rs`**: メインのシステム定義と SystemParam の分割（`FamiliarAiParams` / `FamiliarAiTaskParams`）
  - **Think フェーズ**: 状態更新 → `ApplyDeferred` → タスク委譲/移動の順で実行
- **`familiar_processor.rs`**: 使い魔の処理ロジックを複数の関数に分割
  - `process_squad_management`: 分隊管理
  - `process_recruitment`: リクルート処理
  - `finalize_state_transitions`: 状態遷移の最終確定
  - `process_task_delegation_and_movement`: タスク委譲と移動制御
- **`state_handlers/`**: 各状態のハンドラー
  - `idle.rs`: Idle 状態の処理
  - `searching.rs`: SearchingTask 状態の処理
  - `scouting.rs`: Scouting 状態の処理
  - `supervising.rs`: Supervising 状態の処理
- **`squad.rs`**: 分隊管理（`SquadManager`）
  - `build_squad`: 分隊の構築
  - `validate_squad`: 分隊の検証
  - `release_fatigued`: 疲労・崩壊したメンバーのリリース
- **`task_management.rs`**: タスク管理（`TaskManager`）
  - `find_unassigned_task_in_area`: タスク検索
  - `assign_task_to_worker`: タスク割り当て
  - `delegate_task`: タスク委譲
    - 各アイドル状態のワーカーに対し、その現在地から到達可能なタスクを個別に検索して割り当てます。
- **find_unassigned_task_in_area**: タスク検索
    - **到達可能性チェック**: 空間グリッドから見つかった候補タスクに対し、ワーカーが物理的に到達可能か（パスが存在するか）をチェックします。
    - **Worker-Centric**: 使い魔の現在地ではなく、**ワーカー個々の現在地**を起点として判定を行います。
    - **Ground Projection**: 使い魔（空中ユニット）の位置ではなく、常にワーカー（地上ユニット）が立つ地面の座標に投影してパス計算を開始します。
    - **4方向パス検索**: 上下左右の4方向移動に準拠したパス検索を行い、斜め移動による障害物のすり抜けを防止しています。
- **assign_task_to_worker**: タスク割り当て要求の生成（`TaskAssignmentRequest` を発行し、実適用は Act で行う）
- **`recruitment.rs`**: リクルート管理（`RecruitmentManager`）
  - `find_best_recruit`: リクルート候補の検索
  - `try_immediate_recruit`: 即時リクルート
  - `start_scouting`: スカウト開始
- **`state_transition.rs`**: 状態遷移の検知とイベント発火
  - `detect_state_changes_system`: 状態変更の検知（`Changed<FamiliarAiState>` 使用）
  - `detect_command_changes_system`: コマンド変更の検知（`Changed<ActiveCommand>` 使用）
  - `determine_transition_reason`: 状態遷移理由の判定
- **`max_soul_handler.rs`**: 使役数上限変更イベントの処理
  - `handle_max_soul_changed_system`: 上限超過分の魂をリリース

### 5.2. 関連コンポーネント

- `Familiar`: 使い魔の基本パラメータ（Radius, Speed 等）を保持。
- `FamiliarOperation`: 指揮下に入れる最大人数や、魂を解雇する疲労しきい値を保持。
- `ActiveCommand`: プレイヤーからの直接命令（Idle / Gather / Task）。
- `FamiliarAiState`: AI の現在の状態（Idle, SearchingTask, Scouting, Supervising）。
- `Commanding` (Relationship): 配下の魂への参照リスト。**オプショナル**（分隊が空のとき削除される）。
- `ManagedTasks` (Relationship Target): 管理下のタスクリスト。**オプショナル**（タスクがゼロのとき削除されるため、AI クエリでは `Option` として扱う）。
- `AssignedTask`: 魂が現在実行中のタスク（採取・運搬・建築）を管理。`src/systems/soul_ai/task_execution/types.rs` で定義。
- `IdleState`: 待機中の振る舞いを管理。`src/systems/soul_ai/idle.rs` で管理。

## 6. 分隊が空になったときの挙動

分隊員が全員解放された場合（疲労・ストレス崩壊など）、使い魔は以下のように動作します：

- **スカウト中 (`Scouting`)**: ターゲットへの接近を継続し、リクルートを完了させます。
- **監視中 (`Supervising`)**: 自動的に `SearchingTask` に遷移し、新しい仲間を探します。

> **実装メモ**: Bevy の ECS Relationship システムでは、最後の `CommandedBy` が削除されると `Commanding` も自動削除されます。そのため、クエリでは `Option<&Commanding>` を使用し、`None` の場合は空の分隊として扱います。
## 7. パフォーマンス最適化 (Performance Optimization)

大規模な地獄（数百の魂、数千のタスク指示）でも FPS を維持するため、以下の最適化が行われています。

### 7.1. 共有リソースキャッシュ (SharedResourceCache)
タスク間のリソース競合を O(1) で管理します。従来の `HaulReservationCache` を統合・拡張したものです。
- **仕組み**: Senseフェーズで毎フレーム再構築され、Think/Actフェーズの更新は `ResourceReservationRequest` を通じて反映されます。
- **機能**: 
  - **Destination Reservation**: 搬送先（ストックパイル、タンク、ミキサー）への予約。
  - **Source Reservation**: アイテム（拾う対象）の重複予約防止。
  - **Intra-frame Tracking**: 同一フレーム内での在庫変動（格納・取り出し）を追跡し、コマンド適用前の論理在庫を正確に把握します。

### 7.1.1. TaskQueries の分割
タスク割り当てとタスク実行で必要なクエリを分離し、システム並列性の阻害を抑えています。
- **`TaskAssignmentQueries`**: Familiar AI の割り当て/解除に必要なクエリを集約
- **`TaskQueries`**: Soul AI のタスク実行に必要なクエリを集約

### 7.2. タスク用空間グリッド (DesignationSpatialGrid)
未割り当てのタスク（伐採、採掘、運搬等）を座標ベースで高速検索します。
- **仕組み**: 指定エリア（`TaskArea`）に重なるグリッドセルのみを走査。
- **効果**: 全タスクをイテレートしてエリア判定を行うコスト (O(T)) を排除しました。数千の指示があっても、使い魔は即座に近くの仕事を発見できます。

### 7.3. 段階的リクルート検索
スカウト時の検索範囲を 20 → 40 → 80 → 160 タイルと段階的に拡大します。
- **効果**: 毎フレーム広範囲を検索するのではなく、近い場所から順に探すことで、1フレームあたりのクエリ負荷を分散させています。

### 7.4. 使役数上限変更のイベント駆動処理
使役数の上限変更をイベント駆動で処理します。
- **仕組み**: UIで使役数が変更されたときのみ `FamiliarOperationMaxSoulChangedEvent` を発火し、超過分の魂をリリースします。
- **効果**: 毎フレーム全使い魔の使役数をチェックするコストを排除し、変更時のみ処理を実行することでパフォーマンスを向上させています。

### 7.5. タスク検索結果のキャッシュ
タスクの「有無の判定」と「実際の割り当て」で、同じ条件の空間検索（`find_unassigned_task_in_area`）を繰り返さないように修正しました。
- **効果**: 重い空間検索の回数を半減させ、判断の重複（二重スキャン）による CPU 負荷を抑制しました。

### 7.6. 状態遷移の自動検知（Bevy 標準機能の活用）
`Changed<FamiliarAiState>` フィルタを使用して状態遷移を自動検知します。
- **仕組み**: Bevy の `Changed<T>` フィルタにより、変更されたエンティティのみを処理
- **効果**: 毎フレーム全使い魔の状態をチェックするコストを排除し、変更時のみ処理を実行
- **イベント**: 状態遷移時に `FamiliarAiStateChangedEvent` を発火し、他のシステムが反応可能

## 8. ビジュアルとアニメーション (Visuals & Animation)

使い魔の移動状況に応じて、視覚的なフィードバックを提供します。

### 8.1. 移動アニメーション
- **スプライト**: `familiar_spritesheet.png` を使用（3フレーム）。
- **更新レート**: **5 FPS**（約0.2秒ごとにフレーム切り替え）。
- **挙動**:
    - **移動中**: フレーム 0→1→2 のループ再生。
    - **停止中**: フレーム 0（待機ポーズ）で固定。

### 8.2. 向きの制御 (Flipping)
- 使い魔の移動方向（ベクトルの X 成分）に基づいて、スプライトを左右反転させます。
- **左向き (デフォルト)**: `flip_x = false`
- **右向き**: `flip_x = true`

### 8.3. オーラ演出
- 使い魔の周囲には、指揮範囲を示す 3 つのレイヤーのオーラが表示されます：
    1. **Border**: 指揮範囲の境界を示す固定枠。
    2. **Pulse**: 内側でゆっくりと拡大縮小を繰り返すパルス演出。
    3. **Outline**: エンティティ選択時に表示される強調用のアウトライン。
