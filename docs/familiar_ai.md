# 使い魔 AI (Familiar AI)

使い魔（Familiar）は、「地獄の監督官」として配下の魂（Damned Soul）を管理し、仕事を効率的に進めさせるための AI を備えています。

## 1. AI 状態 (FamiliarAiState)

使い魔は以下の 4 つの状態を持ち、状況に応じて遷移します。

| 状態 (State) | 説明 |
| :--- | :--- |
| **`Idle`** | プレイヤーからの命令が `Idle` の状態。その場に留まります。 |
| **`SearchingTask`** | 次の仕事（Designation）を探している状態。担当エリアを巡回します。 |
| **`Scouting`** | 遠方のフリーの魂をリクルートするために接近している状態。 |
| **`Supervising`** | 配下の魂を監視し、仕事の進捗を管理している状態。 |

## 2. 使役とリクルート (Recruitment)

使い魔は最大 `max_controlled_soul`（個体差あり）名までの部下を持つことができます。

### リクルート条件

魂がリクルート対象となるための条件（詳細は [soul_ai.md](soul_ai.md) 参照）：

1. **未使役**: `CommandedBy` コンポーネントがないこと
2. **タスクなし**: `AssignedTask::None` であること
3. **バイタル良好**: 疲労・ストレスが閾値以下であること
4. **休息中でない**: `ExhaustedGathering` 状態でないこと

> **Note**: リクルート閾値はリリース閾値より低下させて設定されており、リクルート直後にリリースされることを防ぎます。

### リクルート挙動

- **即時リクルート**: `command_radius` 内に条件を満たす魂がいる場合、即座に配下に入れます。
- **スカウト挙動**: 範囲内に魂がいない場合、段階的に検索範囲を拡大（20→40→80→160タイル）して最適な魂を探し、その場所まで移動してリクルートします。
- **リクルート遷移**: リクルート成功後、まだ空きがあれば再び `SearchingTask` に戻って仲間を探します。満員になった場合のみ `Supervising` に移行します。

## 3. 監視ロジック (Supervising)

監視モードでは、部下との「適切な距離」を保ちながら行動します。

### ターゲット選定
- **作業者優先**: 部下の中で「現在タスクを実行中」の者を優先的にターゲットにします。
- **固定タイマー (Sticky Target)**: 頻繁なターゲット切り替えによるカクつきを防ぐため、一度ターゲットを決めたら **2.0 秒間** はその魂を注視し続けます。

### 誘導 (Guidance)
- **エリアへの回帰**: 全員が待機（Idle）状態で、かつ担当エリアから離れている場合、使い魔はエリアの中心へ移動を開始します。部下はこれに合わせてエリア内へ誘導されます。

### 距離の設定 (Director Style)
監督官らしい威厳を保つため、ターゲットのすぐ横ではなく、少し離れた位置（指揮範囲の端）に陣取ります。
- **追従開始**: ターゲットとの距離が **5.0 タイル** を超えたら移動を開始。
- **停止**: ターゲットとの距離が **3.0 タイル** 以内になったら停止。

## 4. 移動と経路探索の最適化

使い魔の動きをスムーズにするため、以下の制御が行われています。

- **パス更新ガード**: 目的地が **0.5 〜 1.0 タイル** 以上変化しない限り、新しい経路（Path）を再計算しません。これにより、微小な移動に伴う「ガタつき」を排除しています。
- **明示的なパス解放**: 停止距離に到達した際、即座に経路情報をクリアすることで、ターゲット周囲での「足踏み」を防いでいます。

## 5. 関連コンポーネント

- `Familiar`: 使い魔の基本パラメータ（Radius, Speed 等）を保持。
- `FamiliarOperation`: 指揮下に入れる最大人数や、魂を解雇する疲労しきい値を保持。
- `ActiveCommand`: プレイヤーからの直接命令（Idle / Gather / Task）。
- `Commanding` (Relationship): 配下の魂への参照リスト。**オプショナル**（分隊が空のとき削除される）。
- `AssignedTask`: 魂が現在実行中のタスク（採取・運搬・建築）を管理。`src/systems/soul_ai/execution.rs` で定義。
- `IdleState`: 待機中の振る舞いを管理。`src/systems/soul_ai/idle.rs` で管理。

## 6. 分隊が空になったときの挙動

分隊員が全員解放された場合（疲労・ストレス崩壊など）、使い魔は以下のように動作します：

- **スカウト中 (`Scouting`)**: ターゲットへの接近を継続し、リクルートを完了させます。
- **監視中 (`Supervising`)**: 自動的に `SearchingTask` に遷移し、新しい仲間を探します。

> **実装メモ**: Bevy の ECS Relationship システムでは、最後の `CommandedBy` が削除されると `Commanding` も自動削除されます。そのため、クエリでは `Option<&Commanding>` を使用し、`None` の場合は空の分隊として扱います。
## 7. パフォーマンス最適化 (Performance Optimization)

大規模な地獄（数百の魂、数千のタスク指示）でも FPS を維持するため、以下の最適化が行われています。

### 7.1. 搬送予約キャッシュ (HaulReservationCache)
ストックパイルへの搬送予約状況を O(1) で管理します。
- **仕組み**: タスク割り当て時に `reserve`、完了/中断時に `release` を呼び出すイベント駆動更新。
- **効果**: 毎フレーム全ソウルを走査して予約状況を再計算するコスト (O(S)) を排除しました。

### 7.2. タスク用空間グリッド (DesignationSpatialGrid)
未割り当てのタスク（伐採、採掘、運搬等）を座標ベースで高速検索します。
- **仕組み**: 指定エリア（`TaskArea`）に重なるグリッドセルのみを走査。
- **効果**: 全タスクをイテレートしてエリア判定を行うコスト (O(T)) を排除しました。数千の指示があっても、使い魔は即座に近くの仕事を発見できます。

### 7.3. 段階的リクルート検索
スカウト時の検索範囲を 20 → 40 → 80 → 160 タイルと段階的に拡大します。
- **効果**: 毎フレーム広範囲を検索するのではなく、近い場所から順に探すことで、1フレームあたりのクエリ負荷を分散させています。

## 8. ビジュアルとアニメーション (Visuals & Animation)

使い魔の移動状況に応じて、視覚的なフィードバックを提供します。

### 8.1. 移動アニメーション
- **スプライト**: `familiar_spritesheet.png` を使用（3フレーム）。
- **更新レート**: **5 FPS**（約0.2秒ごとにフレーム切り替え）。
- **挙動**:
    - **移動中**: フレーム 0→1→2 のループ再生。
    - **停止中**: フレーム 0（待機ポーズ）で固定。

### 8.2. 向きの制御 (Flipping)
- 使い魔の移動方向（ベクトルの X 成分）に基づいて、スプライトを左右反転させます。
- **左向き (デフォルト)**: `flip_x = false`
- **右向き**: `flip_x = true`

### 8.3. オーラ演出
- 使い魔の周囲には、指揮範囲を示す 3 つのレイヤーのオーラが表示されます：
    1. **Border**: 指揮範囲の境界を示す固定枠。
    2. **Pulse**: 内側でゆっくりと拡大縮小を繰り返すパルス演出。
    3. **Outline**: エンティティ選択時に表示される強調用のアウトライン。
