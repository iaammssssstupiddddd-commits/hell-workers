# ワーカー AI (Soul AI)

ワーカー（Damned Soul）は、使い魔の指揮下で働く、または自律的に行動するための AI とバイタル（生体パラメータ）を備えています。

## 1. バイタルシステム (Vitals)

ワーカーには「疲労」「ストレス」「やる気」の 3 つの主要パラメータがあり、行動に影響を与えます。

### 1.1. 疲労 (Fatigue)
活動に応じて蓄積し、限界に達すると休息を必要とします。
- **増加**: タスク実行中 (+0.01/s)、タスク完了時 (採取:+0.10, 運搬:+0.05)。
- **減少**: 待機中 (-0.05/s)、使役下の待機 (-0.01/s)、集会所での休息。
- **閾値**: 使い魔ごとに設定された `fatigue_threshold`（デフォルト 0.8）を超えると使役解除。
- **限界**: 0.9 を超えると `OnExhausted` イベントが発生し、強制的に集会所へ移動（`ExhaustedGathering`）。

### 1.2. ストレス (Stress)
監視下での労働や、過酷な環境で蓄積します。
- **増加**: タスク実行中 (+0.015/s)、監視下での労働（使い魔の効率に応じて追加）。
- **減少**: 通常待機 (-0.02/s)、集会所での休息 (-0.04/s)。
- **ブレイクダウン**: 1.0 に達すると `OnStressBreakdown` が発生。一定時間停止し、タスクと使役を放棄します。
- **回復**: 0.7 まで下がると完全回復し、再び使役可能になります。

### 1.3. やる気 (Motivation) & 怠惰 (Laziness)
使い魔の近接による影響を強く受けます。
- **やる気**: 使い魔の指揮範囲内にいると急速に回復。高いほど作業効率が向上（予定）。
- **怠惰**: 待機時間が長いと蓄積し、高いと自律的な行動（ wandered 等）を取りやすくなります。

## 2. 行動状態 (Idle Behavior)

タスクを持っていないワーカーは、バイタルに応じて以下の行動を取ります。

| 状態 | 条件 | 動作 |
| :--- | :--- | :--- |
| **`Wander`** | 通常（低怠惰） | 周辺を気ままに歩き回る。 |
| **`Idle`** | 待機 | その場に留まる。 |
| **`Gathering`** | 疲労 > 0.8 | 集会所に集まり、他のワーカーと談笑・休息する。 |
| **`ExhaustedGathering`** | 疲労 > 0.9 | 強制的に集会所へ向かう（移動以外の全行動不可）。 |
| **`StressFrozen`** | ストレス 1.0 | ストレスによりその場で硬直する。 |

## 3. タスク実行ロジック (Task Execution)

割り当てられた `AssignedTask` に基づき、以下の 2 つの主要なタスクを実行します。

### 3.1. 採取 (Gather)
- **対象**: 木、岩、建築物など。
- **プロセス**: 対象へ移動 → 作業（プログレスバー表示） → 完了時にアイテムドロップ。

### 3.2. 運搬 (Haul)
- **対象**: 資源アイテム、建築材料。
- **プロセス**: アイテムへ移動 → 拾い上げる (`Holding`) → 備蓄場所へ移動 → 配置。

## 4. 関連コンポーネントと Relationship

Bevy 0.17 の ECS Relationships を使用して、状態を管理しています。

- `DamnedSoul`: 基本ステータス（fatigue, stress, motivation 等）を保持。
- `AssignedTask`: 現在の作業内容。
- `IdleState`: 現在の待機行動。
- `CommandedBy(Entity)`: 指揮している使い魔への参照。
- `WorkingOn(Entity)`: 取り組んでいるタスクへの参照。
- `Holding(Entity)`: 現在持っているアイテム。

## 5. 関連システム

これらは `SoulAiPlugin` によって管理されています。
- `src/systems/soul_ai/vitals.rs`: バイタル更新、監視ストレス、やる気。
- `src/systems/soul_ai/task_execution/`: タスク実行モジュール (`task_execution_system`)。`mod.rs`にメインシステム、各タスクハンドラーは個別ファイルに分割。
- `src/systems/soul_ai/idle.rs`: 待機行動ロジック、ビジュアル更新。
- `src/systems/soul_ai/work.rs`: タスク委任、解除、オートホール。
