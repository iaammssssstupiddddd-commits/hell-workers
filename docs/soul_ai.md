# ワーカー AI (Soul AI)

ワーカー（Damned Soul）は、使い魔の指揮下で働く、または自律的に行動するための AI とバイタル（生体パラメータ）を備えています。

## 1. バイタルシステム (Vitals)

ワーカーには「疲労」「ストレス」「やる気」の 3 つの主要パラメータがあり、行動に影響を与えます。

### 1.1. 疲労 (Fatigue)
活動に応じて蓄積し、限界に達すると休息を必要とします。
- **増加**: タスク実行中 (+0.01/s)、タスク完了時 (採取:+0.10, 運搬:+0.05)。
- **減少**: 待機中 (-0.05/s)、使役下の待機 (-0.01/s)、集会所での休息。
- **閾値**: 使い魔ごとに設定された `fatigue_threshold`（デフォルト 0.8）を超えると使役解除。
- **限界**: 0.9 を超えると `OnExhausted` イベントが発生し、強制的に集会所へ移動（`ExhaustedGathering`）。

### 1.2. ストレス (Stress)
監視下での労働や、過酷な環境で蓄積します。
- **増加**: タスク実行中 (+0.015/s)、監視下での労働（使い魔の効率に応じて追加）、**リクルート時 (+0.10)**、**使い魔の激励 (+0.0125)**。
- **減少**: 通常待機 (-0.02/s)、集会所での休息 (-0.04/s)、Soul同士の会話完了時（即時減少）。
- **ブレイクダウン**: 1.0 に達すると `OnStressBreakdown` が発生。一定時間停止し、タスクと使役を放棄します。
- **回復**: 0.7 まで下がると完全回復し、再び使役可能になります。

### 1.3. やる気 (Motivation) & 怠惰 (Laziness)
使い魔の近接による影響を強く受け、作業効率や移動速度に影響します。
- **自然減少**: 作業・使役中 (-0.05/s)、通常待機 (-0.1/s)。
- **回復**: 監視（使い魔が近くにいる、+0.4x効率）、タスク完了ボーナス（Chop/Mine:+0.02, Haul:+0.01, Build:+0.05）、**リクルート時 (+0.3)**、**使い魔の激励 (+0.025)**。
- **ペナルティ**: 同僚との会話（サボり）終了時に減少 (-0.02)。
- **怠惰**: 待機時間が長いと蓄積し、高いと自律的な行動（ wandered 等）を取りやすくなります。監視によって減少します。

### 1.4. タスク放棄 (Task Abandonment)
やる気が **0.3 (30%)** を下回ると、ワーカーは現在のタスクを放棄 (`OnTaskAbandoned`) してアイドル状態に戻ります。
放棄時には「🙅‍♂️」の絵文字が表示されます。

## 2. 行動状態 (Idle Behavior)

タスクを持っていないワーカーは、バイタルに応じて以下の行動を取ります。

| 状態 | 条件 | 動作 |
| :--- | :--- | :--- |
| **`Wander`** | 通常（低怠惰） | 周辺を気ままに歩き回る。 |
| **`Idle`** | 待機 | その場に留まる。 |
| **`Gathering`** | 疲労 > 0.8 | 集会所に集まり、他のワーカーと談笑・休息する。 |
| **`ExhaustedGathering`** | 疲労 > 0.9 | 強制的に集会所へ向かう（移動以外の全行動不可）。 |
| **`StressFrozen`** | ストレス 1.0 | ストレスによりその場で硬直する。 |
| **`Escaping`** | 使い魔接近 + ストレス > 0.3 | 使い魔から逃走し、安全な集会スポットを探す。 |

### 2.1 逃走システム (Escaping System)

使役されていない魂（タスク未割当・UnderCommandなし）は、使い魔の影響圏に近づきすぎると逃走行動を開始します。

**逃走開始条件:**
- `UnderCommand` なし（使役されていない）
- 最も近い使い魔までの距離 < `command_radius * 1.5`（警戒圏内）
- `stress > 0.3`（ストレスが高い）
  - 警戒圏内にいる間はストレスが緩やかに増加する
- `ExhaustedGathering` 中は対象外（疲労行動を優先）
- `Gathering` 中も対象（ただし警戒圏内にいる場合のみストレスが増加する）
- 判定は `decide::escaping::escaping_decision_system` 内の検出タイマーにより **0.5秒間隔（初回即時）** で実行される

**逃走終了条件:**
- 全ての使い魔から `command_radius * 2.0` 以上離れた（距離判定は障害物を考慮した経路距離を優先）
- 安全な集会スポットに到着した
- タスクが割り当てられた、または使役された

**移動挙動:**
- 使い魔から離れる方向へ移動（基本ベクトル70%）
- 安全な集会スポットがある場合はそちらへ誘導（30%）
- 通常より速い速度で移動
- 逃走先の再評価は `decide::escaping::escaping_decision_system` 内の行動タイマーにより **0.5秒間隔（初回即時）** で実行される

**視覚フィードバック:**
- 青白い色（パニック感）
- 少し傾けた姿勢（走っている感じ）
- 軽い点滅アニメーション

## 3. タスク実行ロジック (Task Execution)

割り当てられた `AssignedTask` に基づき、**Global Cycle Framework (4フェーズ)** に従ってタスクを実行します。

### 3.0. 実行サイクル (Execution Cycle)
すべてのAI処理は以下の順序で厳密にスケジュールされます (`AiSystemSet`)。

```
Perceive → Update → Decide → Execute
```

| フェーズ | 責任 | 主なシステム |
|:--|:--|:--|
| **Perceive** | 環境情報の読み取り、変化の検出 | 現時点では拡張ポイント（逃走ヘルパー/タイマー資源の定義） |
| **Update** | 時間経過による内部状態の変化 | バイタル更新、タイマー、集会スポットメンテナンス |
| **Decide** | 次の行動の選択、要求の生成 | `idle_behavior_decision_system`, `escaping_decision_system`, `DesignationRequest`/`TaskAssignmentRequest` の生成 |
| **Execute** | 決定された行動の実行 | `apply_designation_requests_system`, `apply_task_assignment_requests_system`, `idle_behavior_apply_system`, `escaping_apply_system`, `task_execution` |

**Message/Request パターン**: Decideフェーズで生成された `DesignationRequest`、`TaskAssignmentRequest`、`IdleBehaviorRequest` はExecuteフェーズで読み取られ、実際のコンポーネント更新が行われます。これにより堅牢なフェーズ間通信が実現されています。

### 3.1. 採取 (Gather)
- **対象**: 木、岩、建築物など。
- **プロセス**: 対象へ移動 → 作業（プログレスバー表示） → 完了時にアイテムドロップ。

### 3.2. 運搬 (Haul)
- **対象**: 資源アイテム、建築材料。
- **プロセス**: アイテムへ移動 → 拾い上げる (`Holding`) → 備蓄場所へ移動 → 配置。

## 4. 関連コンポーネントと Relationship

Bevy 0.18 の ECS Relationships を使用して、状態を管理しています。

- `DamnedSoul`: 基本ステータス（fatigue, stress, motivation 等）を保持。
- `AssignedTask`: 現在の作業内容。
- `IdleState`: 現在の待機行動。
- `CommandedBy(Entity)`: 指揮している使い魔への参照。
- `WorkingOn(Entity)`: 取り組んでいるタスクへの参照。
- `Holding(Entity)`: 現在持っているアイテム。
- `Inventory`: アイテムの所持状態を管理する必須コンポーネント。

## 5. 移動と制御 (Movement & Control)

ワーカーの移動は、物理的な障害物（岩、木、川）との相互作用を考慮して制御されています。

### 5.1. パス検索と目的地設定
- **8方向パス検索**: A*アルゴリズムを用いた8方向（上下左右＋斜め）の移動に対応しています。
- **隣接点検索**: タスクのターゲット（岩や建築現場など）への移動時、ターゲットの上下左右4方向の隣接マスのうち、最も近く到達可能な地点を目的地として設定します。
- **平滑化 (Smoothing)**: 障害物がない区間ではパスを直線化し、スムーズな移動を実現します。
- **再計算抑制**: 既にターゲット近傍へ向かう有効なパスを持っている場合、毎フレームの再計算によるループを防ぐガードロジックが実装されています。

### 5.2. スライディング衝突解決 (Sliding Collision)
- **仕様**: 移動システム（`soul_movement`）において、進行方向が通行不可（`WorldMap::is_walkable` が `false`）な場合、X軸またはY軸のみの移動を試みます。
- **効果**: 壁や岩に斜めにぶつかった際、完全に停止するのではなく、壁に沿って滑るように移動できます。
- **救済措置**: 万が一、全方位が塞がれて一歩も動けなくなった場合は、そのウェイポイントを到達済みとみなして次の経路へスキップします。

### 5.3. 障害物埋まりエスケープ (Stuck Escape)
- **検出**: 毎フレーム、ソウルの現在位置が通行不可（`WorldMap::is_walkable_world` が `false`）かどうかを判定します。建築物の配置や障害物の追加で、ソウルが障害物と重なった場合に該当します。
- **処理**: 埋まったソウルは、現在位置から周辺3マス以内の最も近い歩行可能タイルへ即座に移動（テレポート）されます。パスはクリアされ、次フレームで目的地へ向けた経路が再計算されます。
- **実装**: `soul_stuck_escape_system` がパス検索の前に実行され、`WorldMap::get_nearest_walkable_grid` で脱出先を決定します。

### 5.4. インタラクション距離
- ターゲットへの到達判定しきい値は `TILE_SIZE * 1.5` に設定されています。これにより、隣接マスからタスク（採掘、伐採、建築）を開始することが可能です。

## 6. 関連システム
 
これらは `SoulAiPlugin` によって管理されています。
- `src/systems/soul_ai/update/`: バイタル更新、影響計算、集会猶予タイマー更新。
- `src/systems/soul_ai/decide/`: 待機行動・逃走・作業割り当て・集会管理の意思決定。
- `src/systems/soul_ai/execute/`: Request 適用、タスク実行、クリーンアップ、集会スポット生成。
- `src/systems/soul_ai/helpers/`: 集会型定義、クエリ型、作業共通ヘルパー。
- `src/systems/soul_ai/visual/`: アイドル/集会/バイタルの視覚フィードバック。
