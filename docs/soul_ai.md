# ワーカー AI (Soul AI)

ワーカー（Damned Soul）は、使い魔の指揮下で働く、または自律的に行動するための AI とバイタル（生体パラメータ）を備えています。

## 1. バイタルシステム (Vitals)

ワーカーには「疲労」「ストレス」「やる気」の 3 つの主要パラメータがあり、行動に影響を与えます。

### 1.1. 疲労 (Fatigue)
活動に応じて蓄積し、限界に達すると休息を必要とします。
- **増加**: タスク実行中 (+0.01/s)、タスク完了時 (採取:+0.10, 運搬:+0.05)。
- **減少**: 待機中 (-0.05/s)、使役下の待機 (-0.01/s)、集会所での休息。
- **閾値**: 使い魔ごとに設定された `fatigue_threshold`（デフォルト 0.8）を超えると使役解除。
- **限界**: 0.9 を超えると `OnExhausted` イベントが発生し、強制的に集会所へ移動（`ExhaustedGathering`）。

### 1.2. ストレス (Stress)
監視下での労働や、過酷な環境で蓄積します。
- **増加**: タスク実行中 (+0.015/s)、監視下での労働（使い魔の効率に応じて追加）、**リクルート時 (+0.10)**、**使い魔の激励 (+0.0125)**。
- **減少**: 通常待機 (-0.02/s)、集会所での休息 (-0.04/s)、Soul同士の会話完了時（即時減少）。
- **ブレイクダウン**: 1.0 に達すると `OnStressBreakdown` が発生。一定時間停止し、タスクと使役を放棄します。
- **回復**: 0.7 まで下がると完全回復し、再び使役可能になります。

### 1.3. やる気 (Motivation) & 怠惰 (Laziness)
使い魔の近接による影響を強く受け、作業効率や移動速度に影響します。
- **自然減少**: 作業・使役中 (-0.05/s)、通常待機 (-0.1/s)。
- **回復**: 監視（使い魔が近くにいる、+0.4x効率）、タスク完了ボーナス（Chop/Mine:+0.02, Haul:+0.01, Build:+0.05）、**リクルート時 (+0.3)**、**使い魔の激励 (+0.025)**。
- **ペナルティ**: 同僚との会話（サボり）終了時に減少 (-0.02)。
- **怠惰**: 待機時間が長いと蓄積し、高いと自律的な行動（ wandered 等）を取りやすくなります。監視によって減少します。

### 1.4. タスク放棄 (Task Abandonment)
やる気が **0.3 (30%)** を下回ると、ワーカーは現在のタスクを放棄 (`OnTaskAbandoned`) してアイドル状態に戻ります。
放棄時には「🙅‍♂️」の絵文字が表示されます。

## 2. 行動状態 (Idle Behavior)

タスクを持っていないワーカーは、バイタルに応じて以下の行動を取ります。

| 状態 | 条件 | 動作 |
| :--- | :--- | :--- |
| **`Wander`** | 通常（低怠惰） | 周辺を気ままに歩き回る。 |
| **`Idle`** | 待機 | その場に留まる。 |
| **`Gathering`** | 疲労 > 0.8 | 集会所に集まり、他のワーカーと談笑・休息する。 |
| **`ExhaustedGathering`** | 疲労 > 0.9 | 強制的に集会所へ向かう（移動以外の全行動不可）。 |
| **`StressFrozen`** | ストレス 1.0 | ストレスによりその場で硬直する。 |

## 3. タスク実行ロジック (Task Execution)

割り当てられた `AssignedTask` に基づき、以下の 2 つの主要なタスクを実行します。

### 3.1. 採取 (Gather)
- **対象**: 木、岩、建築物など。
- **プロセス**: 対象へ移動 → 作業（プログレスバー表示） → 完了時にアイテムドロップ。

### 3.2. 運搬 (Haul)
- **対象**: 資源アイテム、建築材料。
- **プロセス**: アイテムへ移動 → 拾い上げる (`Holding`) → 備蓄場所へ移動 → 配置。

## 4. 関連コンポーネントと Relationship

Bevy 0.18 の ECS Relationships を使用して、状態を管理しています。

- `DamnedSoul`: 基本ステータス（fatigue, stress, motivation 等）を保持。
- `AssignedTask`: 現在の作業内容。
- `IdleState`: 現在の待機行動。
- `CommandedBy(Entity)`: 指揮している使い魔への参照。
- `WorkingOn(Entity)`: 取り組んでいるタスクへの参照。
- `Holding(Entity)`: 現在持っているアイテム。

## 5. 移動と制御 (Movement & Control)

ワーカーの移動は、物理的な障害物（岩、木、川）との相互作用を考慮して制御されています。

### 5.1. 4方向パス検索
- **仕様**: 移動は上下左右の4方向に限定されています。
- **目的**: 斜め移動を廃止することで、岩の角をすり抜ける「角抜け」現象を防止し、物理的な遮蔽をより正確に機能させます。
- **到達判定**: ターゲットが岩などの通行不可オブジェクトである場合、その上下左右に隣接する最も近い通行可能マスを目的地として自動設定します。

### 5.2. スライディング衝突解決 (Sliding Collision)
- **仕様**: 移動システム（`soul_movement`）において、進行方向が通行不可（`WorldMap::is_walkable` が `false`）な場合、X軸またはY軸のみの移動を試みます。
- **効果**: 壁や岩に斜めにぶつかった際、完全に停止するのではなく、壁に沿って滑るように移動できます。
- **救済措置**: 万が一、全方位が塞がれて一歩も動けなくなった場合は、そのウェイポイントを到達済みとみなして次の経路へスキップします。

### 5.3. インタラクション距離
- ターゲットへの到達判定しきい値は `TILE_SIZE * 1.5` に設定されています。これにより、隣接マスからタスク（採掘、伐採、建築）を開始することが可能です。

## 6. 関連システム
 
これらは `SoulAiPlugin` によって管理されています。
- `src/systems/soul_ai/vitals/`: バイタル（疲労、ストレス、やる気）の更新ロジック。
- `src/systems/soul_ai/idle/`: 待機行動の意思決定、ビジュアルフィードバック、重なり回避。
- `src/systems/soul_ai/gathering/`: 動的な集会所（休息ポイント）の生成、維持。
- `src/systems/soul_ai/work/`: 指揮エリアのオートホール、タスク解除、監視部下の管理。
- `src/systems/soul_ai/task_execution/`: 割り当てられたタスク（採取、運搬、建築）の具体的な実行プロセス。
