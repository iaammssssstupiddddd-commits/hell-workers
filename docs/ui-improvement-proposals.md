# UIパネル ビジュアル・操作感 改善案

> **位置づけ**: 本ドキュメントはインクリメンタルな改善案であり、実装完了後は [`ui-visual-redesign.md`](ui-visual-redesign.md) の根本的再設計へ移行する前提。
> 各項目の実装状況を記載し、再設計時に引き継ぐべき課題を明確にする。

## 現状の概要

現在のUIは以下のパネルで構成されている:
- **左パネル**: エンティティリスト（使い魔・ソウル一覧）— ビューモデルパターンで再構築済み
- **右パネル**: 情報パネル（選択エンティティの詳細）
- **下部バー**: モード切替（Architect / Zones / Orders）
- **右上**: 時間コントロール（時計・速度変更）
- **ツールチップ**: ワールドエンティティのホバー情報

### 直近のリファクタリング成果
- エンティティリストをビューモデルパターン（`EntityListViewModel`）に移行
- リストUI を `list/` サブモジュール（`view_model`, `sync`, `interaction`, `helpers`）に分割
- UIインタラクションを `interaction/` モジュールに分離
- AIシステムクエリをサブモジュールに再編成

---

## 1. ホバーフィードバックの強化

### 実装状況: 🔴 未着手

### 現状
- ソウルリストアイテムにホバー状態がない（背景が変わらない）
- 使い魔ヘッダーのホバー反応が薄い（折りたたみボタンのみ `COLOR_SECTION_TOGGLE_PRESSED` で反応）
- UIボタンにツールチップがない（ワールドエンティティのみ `hover_tooltip_system` で対応）
- ボタンのホバー色は `common.rs` で定義済み（Pressed: 0.5, Hovered: 0.4, None: 0.2）

### 改善案

#### 1-1. リストアイテムのホバーハイライト 🔴
- ソウル行にホバー時の背景色を追加（例: `srgba(0.4, 0.4, 0.6, 0.3)`）
- 角丸（`border_radius: 2px`）を適用し、ホバー領域を明示
- 使い魔ヘッダーも同様にホバー時の視覚変化を強化
- **実装箇所**: `list/interaction.rs` にホバーシステム追加、`list/helpers.rs` のスポーン関数を更新

#### 1-2. ボタンツールチップ 🔴
- 下部バーのボタン（Architect、Zones、Orders）にツールチップを追加
- 時間コントロールボタンにも速度表示ツールチップを追加
- 例: 「||」→「一時停止」、「>>>」→「超高速 (x10)」
- **実装箇所**: `interaction/` にUI要素用ツールチップシステム追加

#### 1-3. カーソル形状の変化 🔴
- クリック可能な要素にホバーした際、カーソルが変わる仕組みの検討
- Bevyのウィンドウカーソル制御（`CursorIcon`）を活用

### → ui-visual-redesign への引き継ぎ
- ホバーステートの3段階体系化（Default → Hover → Active）は再設計ドキュメント §6-1 に詳述
- リストアイテムのホバーは再設計でもPhase 3の基盤要素

---

## 2. 選択状態の視認性向上

### 実装状況: 🔴 未着手

### 現状
- エンティティリストで選択中のアイテムの視覚的ハイライトがない
- 選択はカメラフォーカス移動＋情報パネル表示で確認するしかない
- `SoulListItem(Entity)` / `FamiliarListItem(Entity)` コンポーネントでエンティティ追跡は可能

### 改善案

#### 2-1. 選択ハイライト 🔴
- 選択中のソウル行に明確な背景色を付与（例: `srgba(0.3, 0.5, 0.8, 0.4)`）
- 左ボーダーにアクセントカラーのライン（2〜3px）を表示
- 選択中の使い魔ヘッダーも同様にハイライト
- **実装箇所**: `list/sync.rs` の更新ロジック内で `SelectedEntity` リソースと照合

#### 2-2. フォーカス連動 🔴
- エンティティリストで選択した項目が画面外の場合、自動スクロールで表示
- ワールド上で直接エンティティをクリックした際も、リスト側の該当行をハイライト

### → ui-visual-redesign への引き継ぎ
- 選択フィードバックの強化は再設計ドキュメント §6-2 でパルスアウトライン等も含め拡張

---

## 3. パネルレイアウトの改善

### 実装状況: 🟡 部分的

### 現状
- すべてのパネルが絶対位置（ピクセル指定）で配置されている
  - 左パネル: `left: 20px, top: 120px`, 300px幅, max 70%高さ
  - 右パネル: `right: 20px, top: 120px`, 200px幅
  - 下部バー: `left: 0, bottom: 0, width: 100%`, 50px高さ
- 情報パネル（右）が200px固定で窮屈
- エンティティリストに `Overflow::clip_y()` 適用済み（スクロールバーUIはなし）

### 改善案

#### 3-1. パネルサイズの柔軟化 🔴
- エンティティリストの幅をドラッグでリサイズ可能にする
- 情報パネルの高さを内容に応じて自動調整（最大高さ制限付き）

#### 3-2. スクロール対応 🟡 部分的
- ✅ エンティティリストに `Overflow::clip_y()` 適用済み（内容がクリップされる）
- 🔴 スクロールバーUIは未実装（ユーザーにスクロール可能であることが伝わらない）
- 🔴 情報パネルのスクロール対応なし
- スクロールバーのスタイル: 細め（4px）、半透明、ホバー時に表示

#### 3-3. パネル位置の定数化 🔴
- 現在散在しているパネル位置（`top: 120px`, `left: 20px` 等）を `theme.rs` に集約
- 将来的なレスポンシブ対応の基盤整備

### → ui-visual-redesign への引き継ぎ
- レイアウトシステムの根本的再設計は §7 で詳述（min/max幅、パーセントベース配置等）

---

## 4. カラーテーマの統一

### 実装状況: 🟡 部分的

### 現状
- `theme.rs` に多数のカラー定数が定義済み:
  - 性別色、タスク種別色、ストレス段階色、疲労色、UIアイコン色
  - サイズ定数（`HEADER_HEIGHT`, `SOUL_ITEM_HEIGHT`, `ICON_SIZE` 等）
  - フォントサイズ（`FONT_SIZE_HEADER: 14.0`, `FONT_SIZE_ITEM: 12.0`, `FONT_SIZE_SMALL: 10.0`）
- パネル背景のグラデーション色はsetupファイルにハードコードのまま:
  - 左パネル: 青系 `(0.1, 0.3, 0.5, 0.9)` → 黒
  - 右パネル: 紫系 `(0.3, 0.1, 0.3, 0.9)` → 黒
  - 下部バー: 赤系 `(0.4, 0.1, 0.1, 0.9)` → 黒
- ボタン色は `common.rs` で一元管理（Pressed/Hovered/None の3段階）

### 改善案

#### 4-1. テーマ定数の拡充 🟡 部分的
`theme.rs` に以下を追加:
```
// 🔴 未定義 - パネル背景グラデーション
COLOR_PANEL_LEFT_TOP / COLOR_PANEL_LEFT_BOTTOM
COLOR_PANEL_RIGHT_TOP / COLOR_PANEL_RIGHT_BOTTOM
COLOR_PANEL_BOTTOM_TOP / COLOR_PANEL_BOTTOM_BOTTOM

// ✅ common.rs で定義済み - 汎用ボタン色
COLOR_BUTTON_DEFAULT / COLOR_BUTTON_HOVER / COLOR_BUTTON_PRESSED

// 🔴 未定義 - テキスト色（用途別）
COLOR_TEXT_PRIMARY / COLOR_TEXT_SECONDARY / COLOR_TEXT_ACCENT
```

#### 4-2. ダークテーマの統一感 🔴
- 全パネルの基調色を統一（例: 暗い青紫系に寄せる）
- パネル間の色味の差は維持するが、彩度と明度の範囲を揃える
- ボーダーや区切り線に共通の微光色（例: `srgba(0.5, 0.5, 0.7, 0.3)`）を使用

### → ui-visual-redesign への引き継ぎ
- セマンティックカラーシステム（§4）とベースカラーパレットの完全再構築で置き換え予定

---

## 5. アニメーション・トランジション

### 実装状況: 🔴 未着手

### 現状
- すべてのUI状態変化が即座に切り替わる（`Display::None` ↔ `Display::Flex`）
- 折りたたみ/展開、パネル表示/非表示が瞬間的で唐突
- ツールチップも即座に表示/非表示

### 改善案

#### 5-1. フェードイン/フェードアウト 🔴
- 情報パネルの表示/非表示にフェードアニメーション（0.15秒程度）
- ツールチップの出現にも短いフェード（0.1秒）

#### 5-2. セクション折りたたみアニメーション 🔴
- 使い魔セクションの展開/折りたたみに高さのトランジション
- Bevyのアニメーションシステム、または毎フレームの補間で実現

#### 5-3. 実装の優先度
- パフォーマンスへの影響を最小限にするため、簡素なアルファ補間から着手
- 複雑なレイアウトアニメーションは後回し

### → ui-visual-redesign への引き継ぎ
- ツールチップのフェードインは再設計の §3-3 で遅延（300ms）+フェード（100ms）として定義済み

---

## 6. 情報パネルの充実

### 実装状況: 🔴 未着手

### 現状
- ソウルの情報パネル: テキストのみ（Motivation/Stress/Fatigue のパーセンテージ表示）
- コンポーネントは分離済み（`InfoPanelStatMotivation`, `InfoPanelStatStress`, `InfoPanelStatFatigue`）
- タスク進捗は文字列表示のみ
- 所持品もテキスト表示のみ

### 改善案

#### 6-1. ステータスバーの追加 🔴
- Motivation / Stress / Fatigue にプログレスバーを追加
  - バー背景: 暗いグレー
  - バー塗り: ステータスに応じた色（Stress: 黄→赤、Fatigue: 青紫）
  - バー高さ: 4〜6px、幅: パネル幅に合わせる

#### 6-2. タスク進捗の可視化 🔴
- 現在のタスクにプログレスバーを表示（該当する場合）
- 例: 建築進捗 45% → バーで表示

#### 6-3. アイコンの拡充 🔴
- 情報パネルのステータス項目にもアイコンを表示（エンティティリストと統一）
- Blueprint選択時にビルディングタイプのアイコンを表示

### → ui-visual-redesign への引き継ぎ
- 情報パネルの根本的再設計は §2-3 でエンティティヘッダー、セクション区切り、トレンド表示等を含む

---

## 7. 操作性の改善

### 実装状況: 🔴 未着手

### 現状
- すべての操作がマウスクリックに依存
- コンテキストメニューは使い魔の右クリックのみ（`OperationDialog`）
- キーボードショートカットなし

### 改善案

#### 7-1. キーボードショートカット 🔴
- `1`〜`4`: 時間速度切替
- `Space`: 一時停止/再開トグル
- `B`: Architectモード
- `Z`: Zonesモード
- `Tab`: エンティティリストのフォーカス切替

#### 7-2. ドラッグ＆ドロップ 🔴
- ソウルを使い魔セクション間でドラッグして配属変更
- 直感的な分隊管理の実現

#### 7-3. 右クリックメニューの拡充 🔴
- ソウル右クリック: タスク手動割り当て、使い魔への配属
- リソース右クリック: 優先度設定、運搬指示

### → ui-visual-redesign への引き継ぎ
- コンテキストメニュー再設計は §6-3、ドラッグ操作は §6-4 で詳述

---

## 8. フォント・テキストの整理

### 実装状況: 🟡 部分的

### 現状
- `theme.rs` に3段階のフォントサイズ定数あり: `FONT_SIZE_HEADER: 14.0`, `FONT_SIZE_ITEM: 12.0`, `FONT_SIZE_SMALL: 10.0`
- パネルタイトル（18.0）やツールチップ（14.0）等で直接値が混在
- フォントリソースは `font_ui`, `font_soul_name`, `font_familiar` と分離

### 改善案

#### 8-1. フォントサイズの統一 🟡 部分的
- ✅ `theme.rs` に基本3サイズ定義済み
- 🔴 追加定義が必要: `FONT_SIZE_TITLE: 18.0`, `FONT_SIZE_CLOCK: 16.0` 等
- 🔴 一部ファイルで直接値がまだ使用されている

#### 8-2. フォントリソースの整理 🔴
- 用途別フォント定義を `theme.rs` またはリソースファイルに文書化
- 不要な分岐があれば統合

### → ui-visual-redesign への引き継ぎ
- タイポグラフィの完全体系化は §5 で6段階スケール（XS〜XL）を定義

---

## 実装状況サマリー

| 改善項目 | 状況 | 効果 | 工数 | 優先度 |
|---------|------|------|------|--------|
| 1-1. リストホバーハイライト | 🔴 未着手 | 高 | 小 | **A** |
| 2-1. 選択ハイライト | 🔴 未着手 | 高 | 小 | **A** |
| 4-1. テーマ定数の拡充 | 🟡 部分的 | 中 | 小 | **A** |
| 3-2. スクロール対応 | 🟡 clip_yのみ | 高 | 中 | **B** |
| 6-1. ステータスバー | 🔴 未着手 | 中 | 中 | **B** |
| 7-1. キーボードショートカット | 🔴 未着手 | 中 | 中 | **B** |
| 1-2. ボタンツールチップ | 🔴 未着手 | 中 | 小 | **B** |
| 4-2. ダークテーマ統一 | 🔴 未着手 | 中 | 中 | **B** |
| 8-1. フォントサイズ統一 | 🟡 基本3サイズ済 | 低 | 小 | **B** |
| 5-1. フェードアニメーション | 🔴 未着手 | 中 | 中 | **C** |
| 3-1. パネルリサイズ | 🔴 未着手 | 低 | 大 | **C** |
| 7-2. ドラッグ＆ドロップ | 🔴 未着手 | 高 | 大 | **C** |
| 5-2. 折りたたみアニメーション | 🔴 未着手 | 低 | 大 | **C** |
| 7-3. 右クリックメニュー拡充 | 🔴 未着手 | 中 | 中 | **C** |

**ステータス凡例:**
- 🟢 完了
- 🟡 部分的に実装済み
- 🔴 未着手

**優先度の基準:**
- **A**: すぐに着手すべき（効果が高く工数が小さい）→ **再設計前に実装推奨**
- **B**: 次のイテレーションで対応 → **再設計と並行して検討**
- **C**: 余裕があるときに検討 → **再設計に含めて対応**

---

## 推奨実装順序（ui-visual-redesign 移行前）

### Step 1: 即効性の高い改善（優先度A）
1. **1-1. リストホバーハイライト** — `list/interaction.rs` にホバー検知システム追加
2. **2-1. 選択ハイライト** — `list/sync.rs` で `SelectedEntity` との照合
3. **4-1. パネル背景色の定数化** — setupファイルのハードコード値を `theme.rs` へ移動

### Step 2: 基盤整備（優先度B、再設計の前提）
4. **3-3. パネル位置の定数化** — レイアウト定数を `theme.rs` に集約
5. **8-1. フォントサイズ完全統一** — 直接値をすべて定数に置き換え

### Step 3: ui-visual-redesign へ移行
- Step 1-2 の完了後、再設計ドキュメントの Phase 1（基盤整備）に着手
- 本ドキュメントの残りの 🔴 項目は再設計の各Phaseに統合

---

## 関連ファイル

### ソースコード
- `src/interface/ui/theme.rs` - テーマ定数（サイズ、色、フォント）
- `src/interface/ui/setup/` - 各パネルの構築（entity_list, panels, bottom_bar）
- `src/interface/ui/list/` - エンティティリスト
  - `view_model.rs` - ビューモデル定義（`EntityListViewModel`）
  - `sync.rs` - ビューモデルからUIへの同期
  - `interaction.rs` - クリック・折りたたみ操作
  - `helpers.rs` - UI要素スポーンヘルパー
- `src/interface/ui/interaction/` - UI共通インタラクション
  - `mod.rs` - ツールチップシステム（`hover_tooltip_system`）
  - `common.rs` - ボタンステート管理
- `src/interface/ui/components.rs` - UIコンポーネント定義

### ドキュメント
- [`docs/ui-visual-redesign.md`](ui-visual-redesign.md) - 根本的なビジュアル再設計（本ドキュメントの次のステップ）
- [`docs/entity_list_ui.md`](entity_list_ui.md) - エンティティリスト仕様
- [`docs/info_panel_ui.md`](info_panel_ui.md) - 情報パネル仕様

---

## 変更履歴

- 2026-02-06: 初版作成
- 2026-02-07: 実装状況を反映、ui-visual-redesign への移行パスを追加、関連ファイルを現在のモジュール構造に更新
