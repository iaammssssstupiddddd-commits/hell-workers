# ワールドマップ仕様書 (2026-01-25)

100x100の固定レイアウトを持つワールドマップの仕様です。地形と資源の配置は、ゲームの拠点としての機能を果たすよう設計されています。

## 基本設定

| 項目 | 値 | 定数名 |
|:--|:--|:--|
| マップサイズ | 100 x 100 | `MAP_WIDTH` / `MAP_HEIGHT` |
| タイルサイズ | 32.0 px | `TILE_SIZE` |

## 地形タイプ (`TerrainType`)

| 地形 | 通行 | 説明 |
|:--|:--|:--|
| **Grass** | ○ | 基本となる地面。 |
| **Dirt** | ○ | 疎らに点在する土。岩を破壊した跡地もこの地形になります。 |
| **Sand** | ○ | 川の両岸に広がる砂浜。 |
| **River** | × | マップを**横断**する水場。物理的な障害物として機能します。 |

## 地形生成アルゴリズム

### 蛇行川 (`River`)
- **手法**: パーリンノイズ（1D）によるY軸オフセットの計算。
- **方向**: マップを西から東へ**横断**します。
- **シード**: 42 (固定)
- **川幅**: 5タイル (`RIVER_WIDTH`)
- **生成ロジック**: `src/world/river.rs` に実装。

### 砂浜 (`Sand`)
- 川のタイルから上下2タイル (`SAND_WIDTH`) の範囲に自動生成。

## 資源配置と再生システム

資源は特定のエリアに集中して配置され、一部は時間経過とともに再生します。

### 1. 森林エリア (ForestZone)
- **対象**: 木 (`Tree`)
- **配置**: マップ北西（左上）に広がる森林地。
- **再生ロジック**: `RegrowthManager` によって管理。伐採された箇所に一定時間（デフォルト60秒）経過後、新しい木が再生します。
- **物理特性**: 木は物理的な障害物であり、魂（地上ユニット）は通り抜けることができません。

### 2. 岩石エリア (RockArea)
- **対象**: 岩 (`Rock`)
- **配置**: マップ南東（右下）の険しいエリア。
- **特性**: 岩は強固な障害物です。破壊（採掘）には時間がかかりますが、跡地は `TerrainType::Dirt` に変化し、通行可能になります。

### 3. 初期資源
- ゲーム開始時、中央の拠点付近に少量の木材アイテム (`ResourceItem(Wood)`) が配置されます。

## 物理衝突と通行制御

- **通行不可オブジェクト**: 木、岩、川は物理的な障害物です。
- **スライディング衝突**: 魂が障害物に斜めにぶつかった際、壁に沿って滑るように移動する物理解決が実装されています。
- **8方向パス検索と高度な制御**:
    - **8方向移動**: 上下左右に加え、斜め方向への移動が可能です。
    - **角抜け防止**: 斜め移動時、壁の角をすり抜けないよう判定を行っています。
    - **経路平滑化**: パス探索後、直線で結べる区間をショートカットする平滑化（Path Smoothing）処理を行い、自然な移動を実現しています。
    - **境界到達 (Boundary Reaching)**: 2x2以上の建築物など、ターゲット領域に入り込まずにその境界（隣接マス）で停止する高度なパス探索ロジック（`find_path_to_boundary`）を実装しています。

## 関連ファイル
- `src/world/map/`: マップデータ構造（mod）・レイアウト定数（layout）・生成システム（spawn）
- [river.rs](src/world/river.rs): 川生成アルゴリズム
- [regrowth.rs](src/world/regrowth.rs): 木の再生システム
- [pathfinding.rs](src/world/pathfinding.rs): 通行制御を伴うパス検索
